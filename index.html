<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ATA 2025 Thyroid Cancer Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.25.6/babel.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; }
    .gradient-text { background: linear-gradient(135deg, #059669, #4f46e5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useMemo, useState, useCallback, useRef } = React;

    /* ===================================================================
       CONSTANTS
       =================================================================== */
    const HISTOLOGY_OPTIONS = [
      "Papillary Thyroid Cancer (PTC)",
      "Follicular Thyroid Cancer (FTC)",
      "Oncocytic Thyroid Cancer (OTC)",
      "High-Grade Non-Anaplastic Thyroid Cancer (HGNATC)",
      "NIFTP",
      "Medullary Thyroid Cancer (MTC)"
    ];

    const T_STAGES = [
      { value: "1a", label: "T1a (‚â§1 cm)" },
      { value: "1b", label: "T1b (1‚Äì2 cm)" },
      { value: "2",  label: "T2 (2‚Äì4 cm)" },
      { value: "3a", label: "T3a (>4 cm)" },
      { value: "3b", label: "T3b (Gross ETE)" },
      { value: "4a", label: "T4a (Moderately advanced)" },
      { value: "4b", label: "T4b (Very advanced)" }
    ];

    const N_STAGES = [
      { value: "0",  label: "N0 (No nodes)" },
      { value: "1a", label: "N1a (Level VI/VII)" },
      { value: "1b", label: "N1b (Lateral neck)" }
    ];

    const M_STAGES = [
      { value: "0", label: "M0 (No metastases)" },
      { value: "1", label: "M1 (Distant metastases)" }
    ];

    const AS_CRITERIA = [
      { key: "presumedPTCmicro", label: "Presumed PTC ‚â§1 cm (cT1aN0M0)" },
      { key: "noClinicalNodes",  label: "No clinical evidence of lymph node metastasis" },
      { key: "noETEorInvasion",  label: "No extrathyroidal extension or invasion" },
      { key: "notNearCritical",  label: "Not abutting trachea or recurrent laryngeal nerve" }
    ];

    /* ===================================================================
       CLINICAL LOGIC FUNCTIONS (all outside any component)
       =================================================================== */
    function pickRisk({ histology, tStage, nStage, mStage, activeSurveillance }) {
      if (activeSurveillance === "Yes") return "Low";
      const h = histology || "";
      if (h.includes("(MTC)") || h.includes("High-Grade")) return "High";
      if (mStage === "1") return "High";
      if (tStage === "4a" || tStage === "4b") return "High";
      if (nStage === "1b") return "High";
      if (tStage === "3a" || tStage === "3b" || nStage === "1a") return "Intermediate-High";
      if (tStage === "2" || tStage === "1b") return "Low-Intermediate";
      return "Low";
    }

    function pickResponse({ activeSurveillance, suspiciousUS, structuralDisease, tgTrend, tgAbTrend }) {
      if (activeSurveillance === "Yes") return "Indeterminate";
      if (structuralDisease === "Yes" || suspiciousUS === "Yes") return "Structurally Incomplete";
      if (tgTrend === "Rising" || tgAbTrend === "Rising") return "Biochemically Incomplete";
      return "Excellent";
    }

    function pickTSHTarget({ risk, response }) {
      if (response === "Structurally Incomplete" || response === "Biochemically Incomplete") return "Below normal range";
      if (risk === "Intermediate-High" || risk === "High") return "Below normal range";
      return "Within normal range";
    }

    function shouldConsiderRepeatRAI({ receivedRAI, response, structuralDisease, suspiciousUS, tgTrend, tgAbTrend }) {
      if (receivedRAI !== "Yes") return false;
      if (response === "Structurally Incomplete" || response === "Biochemically Incomplete") return true;
      if (structuralDisease === "Yes" || suspiciousUS === "Yes" || tgTrend === "Rising" || tgAbTrend === "Rising") return true;
      return false;
    }

    function shouldConsiderInitialRAI({ receivedRAI, risk, surgeryType, histology }) {
      if (receivedRAI === "Yes") return false;
      if (surgeryType !== "Total Thyroidectomy") return false;
      if ((histology || "").includes("(MTC)")) return false;
      return (risk === "Intermediate-High" || risk === "High");
    }

    function buildMockRecommendation(payload) {
      const risk = pickRisk(payload);
      const response = pickResponse(payload);
      const tsh = pickTSHTarget({ risk, response });
      const repeatRAI = shouldConsiderRepeatRAI({ ...payload, response });
      const initialRAI = shouldConsiderInitialRAI({ ...payload, risk });

      let immediate = [];
      if (payload.activeSurveillance === "Yes") {
        immediate = [
          "ü©ª Neck ultrasound at 6‚Äì12 months (then yearly if stable)",
          "üìè Document size/location; confirm no high-risk features",
          "üß† Agree triggers for intervention (growth/nodes/symptoms)",
          "üß™ Optional baseline Tg/TgAb; follow per local practice",
          "üìÖ Follow-up visit in 6‚Äì12 months"
        ];
      } else {
        if (response === "Structurally Incomplete") immediate.push("ü©ª Confirm structural disease (US ¬± FNA where appropriate)");
        else if (response === "Biochemically Incomplete") immediate.push("üß™ Confirm trend (same assay); repeat Tg/TgAb if uncertain");
        else immediate.push("‚úÖ Continue risk-adapted surveillance (labs ¬± ultrasound)");

        if (repeatRAI) immediate.push("‚ò¢Ô∏è Consider REPEAT RAI if disease is RAI-avid");
        else if (initialRAI) immediate.push("‚ò¢Ô∏è Consider INITIAL RAI (risk-adapted) after pathology review");
        else if ((payload.histology || "").includes("(MTC)")) immediate.push("üß¨ MTC: calcitonin/CEA trend; RET testing; RAI not indicated");
        else immediate.push("üíä Optimize levothyroxine per TSH target and tolerability");

        immediate.push("üßæ Document ATA risk tier + response category");
        immediate.push("üìÖ Set follow-up frequency per response category");
        immediate.push("üß† MDT discussion for complex/persistent disease");
      }

      let longTerm;
      if (payload.activeSurveillance === "Yes") longTerm = "üß≠ Continue active surveillance; intervene if growth or nodal disease develops.";
      else if (response === "Excellent" && (risk === "Low" || risk === "Low-Intermediate")) longTerm = "üåø De-escalate over time if sustained excellent response. Consider complete remission criteria after 10‚Äì15 years.";
      else if (response === "Indeterminate") longTerm = "üîÅ Reassess to clarify response; adjust intensity based on trends.";
      else longTerm = "üß© Re-stage as needed; consider MDT for persistent/recurrent disease.";

      return [
        `üéØ ATA 2025 Risk Stratification`,
        `${risk} risk of recurrence`,
        ``,
        `üìä Response to Therapy`,
        `${response} response`,
        ``,
        `üéöÔ∏è TSH Target`,
        `${tsh}`,
        ``,
        `‚úÖ Immediate Management (Next 1‚Äì6 months)`,
        ...immediate.slice(0, 5).map((x, i) => `${i + 1}. ${x}`),
        ``,
        `üîÑ Long-Term Strategy`,
        longTerm
      ].join("\n");
    }

    function buildPrompt(formData, computed) {
      const isAS = formData.managementType === "Active Surveillance";
      if (isAS) {
        return `You are an expert endocrinologist. A patient is being considered for active surveillance for thyroid cancer.

Patient Data:
- Age: ${formData.patientAge} years
- Management: Active Surveillance (for presumed cT1aN0M0 PTC)

Provide a CONCISE recommendation following this EXACT format (NO MARKDOWN ASTERISKS, use plain text with emojis only):

üéØ ATA 2025 Risk Classification
[State the risk category]

üìä Management Approach
[Brief statement on active surveillance criteria and suitability]

‚úÖ Immediate Management (Next 1-6 months)
1. [Action item with emoji]
2. [Action item with emoji]
3. [Action item with emoji]
4. [Action item with emoji]
5. [Action item with emoji]

üîÑ Long-Term Strategy
[2-3 sentences on long-term surveillance plan]

IMPORTANT: Do NOT use ** or any markdown formatting. Use only plain text with emojis for section headers.`;
      }

      return `You are an expert endocrinologist specializing in thyroid cancer management. Based on the 2025 ATA Management Guidelines, provide a CONCISE clinical recommendation.

Patient Data:
- Age: ${formData.patientAge} years
- Year of Operation: ${formData.yearOfOperation}
- Surgery: ${formData.surgeryType}
- Histology: ${formData.histology}
- TNM: T${formData.tnmStaging.t}, N${formData.tnmStaging.n}, M${formData.tnmStaging.m}
- Tg: ${formData.labResults.tg || "N/A"} ng/mL | TSH: ${formData.labResults.tsh || "N/A"} mIU/L
- Received RAI Previously: ${formData.receivedRAI}
- Tg Trend: ${formData.tgTrend} | TgAb Trend: ${formData.tgAbTrend}
- Structural Disease: ${formData.structuralDisease}
- Suspicious Ultrasound: ${formData.suspiciousUS}
- Ultrasound Findings: ${formData.ultrasoundFindings || "No new findings"}

CRITICAL MANAGEMENT CONSIDERATIONS:
- If patient has structurally incomplete response or elevated Tg, consider REPEAT RAI therapy if disease is RAI-avid
- If patient received RAI = "Yes", evaluate need for ADDITIONAL RAI therapy based on response
- If patient received RAI = "No", evaluate need for INITIAL RAI therapy
- Surgical options include: completion thyroidectomy, therapeutic neck dissection, or local excision

Provide your recommendation in this EXACT format (NO MARKDOWN ASTERISKS, use plain text with emojis only):

üéØ ATA 2025 Risk Stratification
[State only: Low / Low-Intermediate / Intermediate-High / High risk of recurrence]

üìä Response to Therapy
[State only: Excellent / Biochemically Incomplete / Structurally Incomplete / Indeterminate response]

üéöÔ∏è TSH Target
[State only: Within normal range / Below normal range]

‚úÖ Immediate Management (Next 1-6 months)
1. [Action item with emoji]
2. [Action item with emoji]
3. [Action item with emoji]
4. [Action item with emoji]
5. [Action item with emoji]

üîÑ Long-Term Strategy
[2-3 sentences maximum on surveillance frequency, duration, and de-escalation if applicable]

IMPORTANT:
- Do NOT use ** or any markdown formatting.
- If patient shows biochemically or structurally incomplete response AND received RAI previously, strongly consider recommending REPEAT RAI therapy as first-line option before surgery.
- Keep it brief and actionable.`;
    }


    /* ===================================================================
       REUSABLE UI COMPONENTS ‚Äî ALL DEFINED AT TOP LEVEL (outside App)
       This is the KEY FIX: React won't unmount/remount these on state changes.
       =================================================================== */

    function Card({ children }) {
      return (
        <div className="bg-white rounded-3xl shadow-[0_20px_45px_rgba(15,23,42,0.10)] p-6 md:p-8">
          {children}
        </div>
      );
    }

    function SectionTitle({ icon, title, subtitle }) {
      return (
        <div className="flex items-center gap-3 mb-6">
          <div className="text-2xl">{icon}</div>
          <div>
            <h2 className="text-xl font-bold text-slate-800">{title}</h2>
            {subtitle && <p className="text-sm text-slate-500">{subtitle}</p>}
          </div>
        </div>
      );
    }

    function StepDot({ active, done, label }) {
      const base = "w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-all";
      const cls = done ? "bg-emerald-600 text-white" : active ? "bg-indigo-600 text-white ring-4 ring-indigo-200" : "bg-slate-200 text-slate-500";
      return (
        <div className="flex flex-col items-center gap-1">
          <div className={`${base} ${cls}`}>{done ? "‚úì" : label}</div>
        </div>
      );
    }

    function RadioGroup({ options, value, onChange, name }) {
      return (
        <div className="space-y-3">
          {options.map(opt => {
            const val = typeof opt === "string" ? opt : opt.value;
            const label = typeof opt === "string" ? opt : opt.label;
            return (
              <label key={val} className={`flex items-center p-4 border-2 rounded-2xl cursor-pointer transition-all ${
                value === val ? "border-indigo-600 bg-indigo-50" : "border-slate-200 hover:border-indigo-300"
              }`}>
                <input
                  type="radio"
                  name={name}
                  className="w-5 h-5 accent-indigo-600"
                  checked={value === val}
                  onChange={() => onChange(val)}
                />
                <span className="ml-3 font-semibold text-slate-800">{label}</span>
              </label>
            );
          })}
        </div>
      );
    }

    function SelectField({ label, value, onChange, options, placeholder }) {
      return (
        <div>
          <label className="block text-sm font-semibold text-slate-700 mb-2">{label}</label>
          <select
            value={value}
            onChange={(e) => onChange(e.target.value)}
            className="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:outline-none transition-colors bg-white"
          >
            <option value="">{placeholder || "Select..."}</option>
            {options.map(o => {
              const val = typeof o === "string" ? o : o.value;
              const lab = typeof o === "string" ? o : o.label;
              return <option key={val} value={val}>{lab}</option>;
            })}
          </select>
        </div>
      );
    }

    /* ===================================================================
       NUMERIC INPUT COMPONENT ‚Äî uses uncontrolled pattern to prevent
       focus loss. defaultValue + onInput = no React re-renders while typing.
       =================================================================== */
    function NumericInput({ label, defaultValue, onUpdate, maxDigits, placeholder }) {
      return (
        <div>
          <label className="block text-sm font-semibold text-slate-700 mb-2">{label}</label>
          <input
            className="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:outline-none transition-colors"
            type="text"
            inputMode="numeric"
            autoComplete="off"
            defaultValue={defaultValue}
            onInput={(e) => {
              const v = e.currentTarget.value.replace(/[^0-9]/g, "").slice(0, maxDigits || 4);
              e.currentTarget.value = v;
              onUpdate(v);
            }}
            placeholder={placeholder}
          />
        </div>
      );
    }

    /* Free-text input ‚Äî also uncontrolled */
    function TextInput({ label, defaultValue, onUpdate, placeholder }) {
      return (
        <div>
          <label className="block text-sm font-semibold text-slate-700 mb-2">{label}</label>
          <input
            className="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:outline-none transition-colors"
            type="text"
            autoComplete="off"
            defaultValue={defaultValue}
            onInput={(e) => onUpdate(e.currentTarget.value)}
            placeholder={placeholder}
          />
        </div>
      );
    }

    function TextAreaInput({ label, defaultValue, onUpdate, placeholder, rows }) {
      return (
        <div>
          <label className="block text-sm font-semibold text-slate-700 mb-2">{label}</label>
          <textarea
            className="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:outline-none transition-colors resize-none"
            autoComplete="off"
            rows={rows || 4}
            defaultValue={defaultValue}
            onInput={(e) => onUpdate(e.currentTarget.value)}
            placeholder={placeholder}
          />
        </div>
      );
    }


    /* ===================================================================
       STEP COMPONENTS ‚Äî ALL DEFINED AT TOP LEVEL
       They receive formData, update, updateNested as PROPS.
       =================================================================== */

    function Step1Demographics({ formData, update }) {
      return (
        <Card>
          <SectionTitle icon="üßë‚Äç‚öïÔ∏è" title="Patient Demographics" subtitle="Basic patient information" />
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <NumericInput
              label="Age (years)"
              defaultValue={formData.patientAge}
              onUpdate={(v) => update("patientAge", v)}
              maxDigits={3}
              placeholder="e.g., 52"
            />
            <NumericInput
              label="Year of Operation (optional for AS)"
              defaultValue={formData.yearOfOperation}
              onUpdate={(v) => update("yearOfOperation", v)}
              maxDigits={4}
              placeholder="e.g., 2024"
            />
          </div>
        </Card>
      );
    }

    function Step2Management({ formData, update, updateNested }) {
      return (
        <Card>
          <SectionTitle icon="üß≠" title="Management Approach" subtitle="Surgery vs Active Surveillance" />
          <RadioGroup
            options={["Surgery", "Active Surveillance"]}
            value={formData.managementType}
            onChange={(v) => update("managementType", v)}
            name="managementType"
          />

          {formData.managementType === "Surgery" && (
            <div className="mt-6">
              <p className="text-sm font-semibold text-slate-700 mb-3">Surgery Type</p>
              <RadioGroup
                options={["Total Thyroidectomy", "Lobectomy"]}
                value={formData.surgeryType}
                onChange={(v) => update("surgeryType", v)}
                name="surgeryType"
              />
            </div>
          )}

          {formData.managementType === "Active Surveillance" && (
            <div className="mt-6 space-y-4">
              <p className="text-sm font-semibold text-slate-700">Confirm eligibility criteria (all must be Yes):</p>
              {AS_CRITERIA.map(c => (
                <div key={c.key} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                  <span className="text-sm text-slate-700 flex-1 mr-4">{c.label}</span>
                  <div className="flex gap-2">
                    {["Yes", "No"].map(v => (
                      <button
                        key={v}
                        className={`px-4 py-1.5 rounded-lg text-sm font-semibold transition-all ${
                          formData.asEligibility[c.key] === v
                            ? (v === "Yes" ? "bg-emerald-600 text-white" : "bg-red-500 text-white")
                            : "bg-white border border-slate-300 text-slate-600 hover:border-indigo-400"
                        }`}
                        onClick={() => updateNested(`asEligibility.${c.key}`, v)}
                      >
                        {v}
                      </button>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          )}
        </Card>
      );
    }

    function Step3Histology({ formData, update, isAS }) {
      if (isAS) {
        return (
          <Card>
            <SectionTitle icon="üî¨" title="Histology" subtitle="Active Surveillance pathway" />
            <div className="p-4 bg-emerald-50 border border-emerald-200 rounded-xl text-emerald-800">
              Active Surveillance selected ‚Äî histology not required at this stage. Presumed PTC based on cytology.
            </div>
          </Card>
        );
      }
      return (
        <Card>
          <SectionTitle icon="üî¨" title="Histology" subtitle="Post-surgical pathology" />
          <RadioGroup
            options={HISTOLOGY_OPTIONS}
            value={formData.histology}
            onChange={(v) => update("histology", v)}
            name="histology"
          />
        </Card>
      );
    }

    function Step4TNM({ formData, updateNested, isAS }) {
      if (isAS) {
        return (
          <Card>
            <SectionTitle icon="üìä" title="TNM Staging" subtitle="Active Surveillance pathway" />
            <div className="p-4 bg-emerald-50 border border-emerald-200 rounded-xl text-emerald-800">
              Active Surveillance: presumed cT1aN0M0. TNM staging is not applicable at this stage.
            </div>
          </Card>
        );
      }
      return (
        <Card>
          <SectionTitle icon="üìä" title="TNM Staging" subtitle="AJCC 8th edition" />
          <div className="space-y-4">
            <SelectField
              label="T Stage (Tumour)"
              value={formData.tnmStaging.t}
              onChange={(v) => updateNested("tnmStaging.t", v)}
              options={T_STAGES}
              placeholder="Select T stage"
            />
            <SelectField
              label="N Stage (Nodes)"
              value={formData.tnmStaging.n}
              onChange={(v) => updateNested("tnmStaging.n", v)}
              options={N_STAGES}
              placeholder="Select N stage"
            />
            <SelectField
              label="M Stage (Metastases)"
              value={formData.tnmStaging.m}
              onChange={(v) => updateNested("tnmStaging.m", v)}
              options={M_STAGES}
              placeholder="Select M stage"
            />
          </div>
        </Card>
      );
    }

    function Step5Response({ formData, update, isAS }) {
      if (isAS) {
        return (
          <Card>
            <SectionTitle icon="üìà" title="Response Assessment" subtitle="Active Surveillance pathway" />
            <div className="p-4 bg-emerald-50 border border-emerald-200 rounded-xl text-emerald-800">
              Active Surveillance: response assessment is based on serial ultrasound monitoring.
            </div>
          </Card>
        );
      }
      return (
        <Card>
          <SectionTitle icon="üìà" title="Response Assessment" subtitle="Post-treatment monitoring data" />
          <div className="space-y-6">
            <div>
              <p className="text-sm font-semibold text-slate-700 mb-3">Previous RAI therapy?</p>
              <RadioGroup
                options={["Yes", "No"]}
                value={formData.receivedRAI}
                onChange={(v) => update("receivedRAI", v)}
                name="receivedRAI"
              />
            </div>
            <div>
              <p className="text-sm font-semibold text-slate-700 mb-3">Thyroglobulin (Tg) trend</p>
              <RadioGroup
                options={["Rising", "Stable", "Declining", "Undetectable"]}
                value={formData.tgTrend}
                onChange={(v) => update("tgTrend", v)}
                name="tgTrend"
              />
            </div>
            <div>
              <p className="text-sm font-semibold text-slate-700 mb-3">TgAb trend</p>
              <RadioGroup
                options={["Rising", "Stable", "Declining", "Negative"]}
                value={formData.tgAbTrend}
                onChange={(v) => update("tgAbTrend", v)}
                name="tgAbTrend"
              />
            </div>
            <div>
              <p className="text-sm font-semibold text-slate-700 mb-3">Known structural disease?</p>
              <RadioGroup
                options={["Yes", "No"]}
                value={formData.structuralDisease}
                onChange={(v) => update("structuralDisease", v)}
                name="structuralDisease"
              />
            </div>
          </div>
        </Card>
      );
    }

    function Step6Ultrasound({ formData, update, updateNested, isAS }) {
      if (isAS) {
        return (
          <Card>
            <SectionTitle icon="ü©ª" title="Ultrasound & Labs" subtitle="Active Surveillance pathway" />
            <div className="p-4 bg-emerald-50 border border-emerald-200 rounded-xl text-emerald-800">
              Active Surveillance: ultrasound surveillance schedule will be included in recommendations.
            </div>
          </Card>
        );
      }
      return (
        <Card>
          <SectionTitle icon="ü©ª" title="Ultrasound & Labs" subtitle="Current imaging and laboratory data" />
          <div className="space-y-6">
            <div>
              <p className="text-sm font-semibold text-slate-700 mb-3">Suspicious findings on latest ultrasound?</p>
              <RadioGroup
                options={["Yes", "No"]}
                value={formData.suspiciousUS}
                onChange={(v) => update("suspiciousUS", v)}
                name="suspiciousUS"
              />
            </div>
            <TextAreaInput
              label="Ultrasound findings (free text, optional)"
              defaultValue={formData.ultrasoundFindings}
              onUpdate={(v) => update("ultrasoundFindings", v)}
              placeholder="e.g., 8mm hypoechoic nodule in right thyroid bed..."
              rows={3}
            />
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <TextInput
                label="Latest Tg (ng/mL)"
                defaultValue={formData.labResults.tg}
                onUpdate={(v) => updateNested("labResults.tg", v)}
                placeholder="e.g., 0.2"
              />
              <TextInput
                label="Latest TSH (mIU/L)"
                defaultValue={formData.labResults.tsh}
                onUpdate={(v) => updateNested("labResults.tsh", v)}
                placeholder="e.g., 1.5"
              />
            </div>
          </div>
        </Card>
      );
    }

    function Step7Summary({ formData, computed, isAS }) {
      const riskColor = {
        "Low": "bg-emerald-100 text-emerald-800",
        "Low-Intermediate": "bg-yellow-100 text-yellow-800",
        "Intermediate-High": "bg-orange-100 text-orange-800",
        "High": "bg-red-100 text-red-800"
      };
      return (
        <Card>
          <SectionTitle icon="üìã" title="Review Summary" subtitle="Verify data before generating recommendation" />

          <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="p-3 bg-slate-50 rounded-xl">
                <p className="text-xs text-slate-500">Age</p>
                <p className="font-bold text-slate-800">{formData.patientAge || "‚Äî"} years</p>
              </div>
              <div className="p-3 bg-slate-50 rounded-xl">
                <p className="text-xs text-slate-500">Management</p>
                <p className="font-bold text-slate-800">{formData.managementType || "‚Äî"}</p>
              </div>
            </div>

            {!isAS && (
              <>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                  <div className="p-3 bg-slate-50 rounded-xl">
                    <p className="text-xs text-slate-500">Surgery</p>
                    <p className="font-bold text-slate-800">{formData.surgeryType || "‚Äî"}</p>
                  </div>
                  <div className="p-3 bg-slate-50 rounded-xl">
                    <p className="text-xs text-slate-500">Year</p>
                    <p className="font-bold text-slate-800">{formData.yearOfOperation || "‚Äî"}</p>
                  </div>
                  <div className="p-3 bg-slate-50 rounded-xl">
                    <p className="text-xs text-slate-500">Histology</p>
                    <p className="font-bold text-slate-800">{formData.histology || "‚Äî"}</p>
                  </div>
                </div>

                <div className="grid grid-cols-3 gap-4">
                  <div className="p-3 bg-slate-50 rounded-xl">
                    <p className="text-xs text-slate-500">T Stage</p>
                    <p className="font-bold text-slate-800">T{formData.tnmStaging.t || "‚Äî"}</p>
                  </div>
                  <div className="p-3 bg-slate-50 rounded-xl">
                    <p className="text-xs text-slate-500">N Stage</p>
                    <p className="font-bold text-slate-800">N{formData.tnmStaging.n || "‚Äî"}</p>
                  </div>
                  <div className="p-3 bg-slate-50 rounded-xl">
                    <p className="text-xs text-slate-500">M Stage</p>
                    <p className="font-bold text-slate-800">M{formData.tnmStaging.m || "‚Äî"}</p>
                  </div>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                  <div className="p-3 bg-slate-50 rounded-xl">
                    <p className="text-xs text-slate-500">Prior RAI</p>
                    <p className="font-bold text-slate-800">{formData.receivedRAI || "‚Äî"}</p>
                  </div>
                  <div className="p-3 bg-slate-50 rounded-xl">
                    <p className="text-xs text-slate-500">Tg Trend</p>
                    <p className="font-bold text-slate-800">{formData.tgTrend || "‚Äî"}</p>
                  </div>
                  <div className="p-3 bg-slate-50 rounded-xl">
                    <p className="text-xs text-slate-500">TgAb Trend</p>
                    <p className="font-bold text-slate-800">{formData.tgAbTrend || "‚Äî"}</p>
                  </div>
                </div>
              </>
            )}

            {/* Computed risk badge */}
            <div className="mt-4 p-4 bg-indigo-50 border border-indigo-200 rounded-xl">
              <p className="text-xs text-indigo-500 font-semibold mb-2">COMPUTED RISK TIER</p>
              <span className={`inline-block px-4 py-1.5 rounded-full text-sm font-bold ${riskColor[computed.computedRiskTier] || "bg-slate-100 text-slate-700"}`}>
                {computed.computedRiskTier} Risk
              </span>
              {!isAS && (
                <span className={`inline-block ml-2 px-4 py-1.5 rounded-full text-sm font-bold bg-blue-100 text-blue-800`}>
                  {computed.computedResponse} Response
                </span>
              )}
            </div>
          </div>
        </Card>
      );
    }

    function RecommendationDisplay({ recommendation, loading }) {
      if (loading) {
        return (
          <Card>
            <div className="flex flex-col items-center justify-center py-12">
              <div className="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
              <p className="text-slate-600 font-semibold">Generating recommendation...</p>
              <p className="text-sm text-slate-400 mt-1">Analyzing patient data against ATA 2025 guidelines</p>
            </div>
          </Card>
        );
      }
      if (!recommendation) return null;
      return (
        <Card>
          <SectionTitle icon="ü©∫" title="ATA 2025 Recommendation" subtitle="Evidence-based clinical guidance" />
          <div className="whitespace-pre-wrap text-slate-700 leading-relaxed text-sm bg-slate-50 rounded-xl p-5 border border-slate-200">
            {recommendation}
          </div>
        </Card>
      );
    }


    /* ===================================================================
       MAIN APP COMPONENT
       Only state management and orchestration lives here.
       No component definitions inside this function!
       =================================================================== */

    function App() {
      const [step, setStep] = useState(1);
      const [loading, setLoading] = useState(false);
      const [recommendation, setRecommendation] = useState(null);
      const [formVersion, setFormVersion] = useState(1);

      const [formData, setFormData] = useState({
        patientAge: "",
        yearOfOperation: "",
        managementType: "",
        surgeryType: "",
        asEligibility: { presumedPTCmicro: "", noClinicalNodes: "", noETEorInvasion: "", notNearCritical: "" },
        histology: "",
        tnmStaging: { t: "", n: "", m: "" },
        receivedRAI: "",
        tgTrend: "",
        tgAbTrend: "",
        structuralDisease: "",
        labResults: { tg: "", tsh: "" },
        suspiciousUS: "",
        ultrasoundFindings: ""
      });

      const isAS = formData.managementType === "Active Surveillance";
      const totalSteps = 7;

      const update = useCallback((field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
      }, []);

      const updateNested = useCallback((path, value) => {
        const [a, b] = path.split(".");
        setFormData(prev => ({ ...prev, [a]: { ...prev[a], [b]: value } }));
      }, []);

      const canProceed = useMemo(() => {
        switch (step) {
          case 1: return formData.patientAge !== "";
          case 2:
            if (!formData.managementType) return false;
            if (formData.managementType === "Surgery") return !!formData.surgeryType;
            const e = formData.asEligibility;
            return e.presumedPTCmicro === "Yes" && e.noClinicalNodes === "Yes" && e.noETEorInvasion === "Yes" && e.notNearCritical === "Yes";
          case 3: return isAS ? true : !!formData.histology;
          case 4:
            if (isAS) return true;
            return !!formData.tnmStaging.t && !!formData.tnmStaging.n && !!formData.tnmStaging.m;
          case 5:
            if (isAS) return true;
            if (!formData.receivedRAI) return false;
            return !!formData.tgTrend && !!formData.tgAbTrend && !!formData.structuralDisease;
          case 6:
            if (isAS) return true;
            return !!formData.suspiciousUS;
          case 7: return true;
          default: return false;
        }
      }, [step, formData, isAS]);

      const computed = useMemo(() => {
        const hints = {
          isActiveSurveillance: isAS,
          computedRiskTier: pickRisk({
            histology: formData.histology,
            tStage: formData.tnmStaging.t,
            nStage: formData.tnmStaging.n,
            mStage: formData.tnmStaging.m,
            activeSurveillance: isAS ? "Yes" : "No"
          }),
          computedResponse: pickResponse({
            activeSurveillance: isAS ? "Yes" : "No",
            suspiciousUS: formData.suspiciousUS,
            structuralDisease: formData.structuralDisease,
            tgTrend: formData.tgTrend,
            tgAbTrend: formData.tgAbTrend
          })
        };
        hints.considerRepeatRAI = shouldConsiderRepeatRAI({
          receivedRAI: formData.receivedRAI,
          response: hints.computedResponse,
          structuralDisease: formData.structuralDisease,
          suspiciousUS: formData.suspiciousUS,
          tgTrend: formData.tgTrend,
          tgAbTrend: formData.tgAbTrend
        });
        hints.considerInitialRAI = shouldConsiderInitialRAI({
          receivedRAI: formData.receivedRAI,
          risk: hints.computedRiskTier,
          surgeryType: formData.surgeryType,
          histology: formData.histology
        });
        hints.computedTSHTarget = pickTSHTarget({ risk: hints.computedRiskTier, response: hints.computedResponse });
        return hints;
      }, [formData, isAS]);

      const resetAll = useCallback(() => {
        setRecommendation(null);
        setStep(1);
        setFormVersion(v => v + 1);
        setFormData({
          patientAge: "",
          yearOfOperation: "",
          managementType: "",
          surgeryType: "",
          asEligibility: { presumedPTCmicro: "", noClinicalNodes: "", noETEorInvasion: "", notNearCritical: "" },
          histology: "",
          tnmStaging: { t: "", n: "", m: "" },
          receivedRAI: "",
          tgTrend: "",
          tgAbTrend: "",
          structuralDisease: "",
          labResults: { tg: "", tsh: "" },
          suspiciousUS: "",
          ultrasoundFindings: ""
        });
      }, []);

      const generateRecommendation = useCallback(async () => {
        setLoading(true);
        setRecommendation(null);
        try {
          // Try live API first (works in claude.ai artifacts)
          const prompt = buildPrompt(formData, computed);
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 2000,
              messages: [{ role: "user", content: prompt }]
            })
          });
          if (response.ok) {
            const data = await response.json();
            if (data.content && data.content[0]) {
              setRecommendation(data.content[0].text);
              return;
            }
          }
          // Fallback to mock
          const payload = {
            activeSurveillance: isAS ? "Yes" : "No",
            histology: formData.histology,
            tStage: formData.tnmStaging.t,
            nStage: formData.tnmStaging.n,
            mStage: formData.tnmStaging.m,
            suspiciousUS: formData.suspiciousUS,
            structuralDisease: formData.structuralDisease,
            tgTrend: formData.tgTrend,
            tgAbTrend: formData.tgAbTrend,
            receivedRAI: formData.receivedRAI,
            surgeryType: formData.surgeryType
          };
          setRecommendation(buildMockRecommendation(payload));
        } catch (err) {
          // If API fails, use mock recommendation
          const payload = {
            activeSurveillance: isAS ? "Yes" : "No",
            histology: formData.histology,
            tStage: formData.tnmStaging.t,
            nStage: formData.tnmStaging.n,
            mStage: formData.tnmStaging.m,
            suspiciousUS: formData.suspiciousUS,
            structuralDisease: formData.structuralDisease,
            tgTrend: formData.tgTrend,
            tgAbTrend: formData.tgAbTrend,
            receivedRAI: formData.receivedRAI,
            surgeryType: formData.surgeryType
          };
          setRecommendation(buildMockRecommendation(payload));
        } finally {
          setLoading(false);
        }
      }, [formData, computed, isAS]);

      /* Render the correct step ‚Äî note: no component definitions here! */
      const renderStep = () => {
        switch (step) {
          case 1: return <Step1Demographics key={`s1-${formVersion}`} formData={formData} update={update} />;
          case 2: return <Step2Management key={`s2-${formVersion}`} formData={formData} update={update} updateNested={updateNested} />;
          case 3: return <Step3Histology key={`s3-${formVersion}`} formData={formData} update={update} isAS={isAS} />;
          case 4: return <Step4TNM key={`s4-${formVersion}`} formData={formData} updateNested={updateNested} isAS={isAS} />;
          case 5: return <Step5Response key={`s5-${formVersion}`} formData={formData} update={update} isAS={isAS} />;
          case 6: return <Step6Ultrasound key={`s6-${formVersion}`} formData={formData} update={update} updateNested={updateNested} isAS={isAS} />;
          case 7: return <Step7Summary key={`s7-${formVersion}`} formData={formData} computed={computed} isAS={isAS} />;
          default: return null;
        }
      };

      const stepLabels = ["Demographics", "Management", "Histology", "TNM", "Response", "Ultrasound", "Summary"];

      return (
        <div className="min-h-screen py-8 px-4">
          <div className="max-w-2xl mx-auto">
            {/* Header */}
            <div className="text-center mb-8">
              <div className="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-gradient-to-r from-emerald-600 to-indigo-600 text-white text-xs font-bold tracking-wide mb-3">
                ATA 2025 GUIDELINES
              </div>
              <h1 className="text-4xl md:text-5xl font-extrabold text-slate-900">
                Thyroid Cancer <span className="gradient-text">Assistant</span>
              </h1>
              <p className="text-slate-500 mt-2">Evidence-based clinical decision support</p>
            </div>

            {/* Progress */}
            <div className="mb-8">
              <div className="flex items-center justify-between">
                {stepLabels.map((label, i) => {
                  const s = i + 1;
                  return (
                    <div key={s} className="flex items-center">
                      <StepDot active={s === step} done={s < step} label={s} />
                      {s < totalSteps && <div className={`h-1 w-4 md:w-8 mx-0.5 rounded ${s < step ? "bg-emerald-500" : "bg-slate-200"}`} />}
                    </div>
                  );
                })}
              </div>
              <div className="mt-3 text-center">
                <span className="text-sm font-semibold text-indigo-600">Step {step}:</span>
                <span className="text-sm text-slate-600 ml-1">{stepLabels[step - 1]}</span>
              </div>
            </div>

            {/* Step Content */}
            <div className="mb-6">
              {renderStep()}
            </div>

            {/* Navigation */}
            <div className="flex justify-between items-center gap-4 mb-6">
              <button
                className="px-6 py-3 rounded-xl font-semibold text-sm transition-all bg-white border-2 border-slate-200 text-slate-600 hover:border-slate-400 disabled:opacity-30"
                disabled={step === 1}
                onClick={() => setStep(s => Math.max(1, s - 1))}
              >
                ‚Üê Back
              </button>

              {step < totalSteps ? (
                <button
                  className="px-8 py-3 rounded-xl font-semibold text-sm text-white transition-all disabled:opacity-30"
                  style={canProceed ? { background: "linear-gradient(90deg, #0ea5e9, #6366f1)" } : { background: "rgb(203 213 225)", color: "rgb(100 116 139)" }}
                  disabled={!canProceed}
                  onClick={() => setStep(s => Math.min(totalSteps, s + 1))}
                >
                  Continue ‚Üí
                </button>
              ) : (
                <button
                  className="px-8 py-3 rounded-xl font-bold text-sm text-white transition-all disabled:opacity-50"
                  style={{ background: "linear-gradient(90deg, #059669, #10b981)" }}
                  disabled={loading}
                  onClick={generateRecommendation}
                >
                  {loading ? "Generating..." : "ü©∫ Generate Recommendation"}
                </button>
              )}
            </div>

            {/* Recommendation Output */}
            <RecommendationDisplay recommendation={recommendation} loading={loading} />

            {/* Reset button */}
            {recommendation && (
              <div className="mt-6 text-center">
                <button
                  className="px-6 py-3 rounded-xl font-semibold text-sm bg-white border-2 border-slate-200 text-slate-600 hover:border-red-300 hover:text-red-600 transition-all"
                  onClick={resetAll}
                >
                  üîÑ New Patient Assessment
                </button>
              </div>
            )}

            {/* Footer */}
            <div className="mt-10 text-center text-xs text-slate-400">
              <p>Based on ATA 2025 Management Guidelines for Differentiated Thyroid Cancer</p>
              <p className="mt-1">For clinical decision support only ‚Äî always apply clinical judgment.</p>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
